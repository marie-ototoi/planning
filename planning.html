<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <link rel="stylesheet" type="text/css" href="planning.css" />
    <script type="text/javascript" src="d3.v4.js"></script>
    <script type="text/javascript" src="d3-time-format.js"></script>
    <script>
    function draw(data) {
        "use strict";
        
        var dateStart = new Date(data[0].date);
        var dateEnd = new Date(data[data.length -1].date);
        //console.log(data)
        data = data.map(function(entry){
            return { "date" :new Date (entry.date), "type": entry.type };
        })

        console.log(d3)
        var formatWeek = d3.timeFormat("%W"),       // Monday-based week of the year as a decimal number [00,53].
        formatMonth = d3.timeFormat("%m"),          // month as a decimal number [01,12].
        formatShortMonthName = d3.timeFormat("%b"), // abbreviated month name.
        formatDayMonth = d3.timeFormat("%e"),       // space-padded day of the month as a decimal number [ 1,31]; equivalent to %_d.
        formatMonthName = d3.timeFormat("%B"),      // full month name.
        formatYear = d3.timeFormat("%Y"),           // year with century as a decimal number.
        formatYearMonth = d3.timeFormat("%Y-%m");
        

        var calendarData = d3.nest()
        .key(function(d) { return formatYearMonth(d.date);  })
        .key(function(d) { return formatWeek(d.date);  })
        .entries(data);

        //console.log(navData)
        //console.log(calendarData)
        var navItem = d3.select(".timeline")
            .append("ul")
            .selectAll("li")
            .data(calendarData)
            .enter()
                .append("li")
                .attr("class", function(d){ return d.key; });
        navItem        
            .append("span")
            .attr("class", function(d,i){ return (i == 0 || d.key.substr(5,2) == "01") ? "year": "year hidden"; })
            .text(function(d){ return d.key.substr(0,4); });
                
        navItem
            .append("span")
            .attr("class", "month")
            .text(function(d){ return formatShortMonthName(new Date(d.key)); });


        var calendarItem = d3.select(".calendars")
            .selectAll("section")
            .data(calendarData)
            .enter()
                .append("section")
                .attr("class", function(d, i){ var now = new Date(); return ( formatYearMonth(now) == d.key || ((dateStart>now ||dateEnd<now) && i == 0) ) ? "monthDetail " + d.key : "monthDetail hidden " + d.key; });

        calendarItem
            .append("h1")
            .text(function(d){ return (d.key); });

        calendarItem
            .selectAll(".row")
            .data(function(d){ return d.values; })
            .enter()
                .append("div")
                .attr("class", function(d,i){ return (i == 0) ? "row first-row" : "row"; })
                .selectAll(".day")
                .data(function(d){ return d.values; })
                .enter()
                    .append("div")
                    .attr("class", function(d){ return  "day " + d.type; })
                    .text(function(d){ return formatDayMonth(d.date); })
       

            
            
    }
    </script>
</head>
<body>

    <script>
        d3.json('planning.json', draw);
    </script>

    <nav class="timeline"></nav>
    <main class="calendar">
        <div class="previous">&lsaquo;</div>
        <div class="calendars"></div>
        <div class="next">&rsaquo;</div>
    </main>
    <footer>
        <ul>
            <li class="IL">ILDA</li>
            <li class="LO">Logilab</li>
            <li class="SC">Université</li>
            <li class="CO">Conférence</li>
            <li class="HO">Congés</li>
        </ul>
    </footer>
</body>
</html>